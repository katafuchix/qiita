<!--
title:   Docker  Rails6  + MySQL macç’°å¢ƒæ§‹ç¯‰ãƒ¡ãƒ¢
tags:    Docker
id:      506cdf8c1595666207c5
private: false
-->
## Docker ã‚’ä½¿ã£ã¦ã®macä¸Šã§ã® Rails6 , MySQL 5.7 ç’°å¢ƒæ§‹ç¯‰ãƒ¡ãƒ¢
https://www.docker.com/
å…¬å¼ãƒšãƒ¼ã‚¸ã‹ã‚‰macç”¨ã®dockerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã“ã¨

[ãƒ•ã‚¡ã‚¤ãƒ«ä¸€å¼](https://github.com/katafuchix/docker_rails6)

## ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™
ãƒ»docker-compose.yml

```docker-compose.yml
version: '3'
services:
  db:
    image: mysql:5.7
    environment:
      MYSQL_DATABASE: root
      MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
    ports:
      - "3306:3306"
    volumes:
      # åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹SQLãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹dir
      - ./db/mysql_init:/docker-entrypoint-initdb.d
      # æ°¸ç¶šåŒ–ã™ã‚‹ã¨ãã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹dir
      - ./db/mysql_data:/var/lib/mysql

  web:
    build: .
    command: rails s -p 3000 -b '0.0.0.0'
    volumes:
      - .:/app_name
    ports:
      - "3000:3000"
    links:
      - db
```

ãƒ»Dockerfile

```Dockerfile
FROM ruby:2.7.1

RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - \
    && echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update -qq && \
    apt-get install -y build-essential \
                       libpq-dev \
                       nodejs yarn

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆã€è¨­å®š
RUN mkdir /app_name
##ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã‚’APP_ROOTã«å‰²ã‚Šå½“ã¦ ä»¥ä¸‹$APP_ROOTã§å‚ç…§
ENV APP_ROOT /app_name
WORKDIR $APP_ROOT

# ãƒ›ã‚¹ãƒˆå´ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ã®Gemfileã‚’è¿½åŠ ã™ã‚‹
ADD ./Gemfile $APP_ROOT/Gemfile
ADD ./Gemfile.lock $APP_ROOT/Gemfile.lock

# Gemfileã®bundle install
RUN bundle install
ADD . $APP_ROOT

# ãŠã¾ã˜ãªã„
# Add a script to be executed every time the container starts.
COPY entrypoint.sh /usr/bin/
RUN chmod +x /usr/bin/entrypoint.sh
ENTRYPOINT ["entrypoint.sh"]
EXPOSE 3000

# Start the main process.
CMD ["rails", "server", "-b", "0.0.0.0"]

```

ãƒ»Gemfile

```Gemfile
source 'https://rubygems.org'
gem 'rails', '6.0.3'
```

ãƒ»Gemfile.lockï¼ˆç©ºã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

ãƒ»entrypoint.sh

```entrypoint.sh
#!/bin/bash
set -e

# Remove a potentially pre-existing server.pid for Rails.
rm -f /app_name/tmp/pids/server.pid

# Then exec the container's main process (what's set as CMD in the Dockerfile).
exec "$@"
```

ã€Œapp_nameã€ã‚’é–“é•ãˆãªã„ã‚ˆã†ã«ã€€æœ¬å½“ã¯ç’°å¢ƒç·¨é›†ã‹ã‚‰å–å¾—ã™ã‚‹ã®ãŒè‰¯ã•ãã†

## mysql, rails ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
docker-compose run web rails new . --skip-action-mailer --skip-active-storage --skip-action-cable -d mysql
```

## èµ·å‹•ã¨ç¢ºèª
database.ymlã®ä¿®æ­£

```database.yml
default: &default
  adapter: mysql2
  encoding: utf8mb4
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  username: root
  password:
  host: db  # docker-compose.ymlã§å®šç¾©ã—ãŸMySQLã®ã‚µãƒ¼ãƒ“ã‚¹å
```


DBåˆæœŸåŒ–

```
docker-compose run web rake db:create
```

èµ·å‹•

```
docker-compose up web  
```

ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã®ã§å†åº¦ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ

```
docker-compose up web
docker_rails6_db_1 is up-to-date
Creating docker_rails6_web_1 ... done
Attaching to docker_rails6_web_1
web_1  | => Booting Puma
web_1  | => Rails 6.0.3.2 application starting in development 
web_1  | => Run `rails server --help` for more startup options
web_1  | Exiting
web_1  | /usr/local/bundle/gems/webpacker-4.2.2/lib/webpacker/configuration.rb:95:in `rescue in load': Webpacker configuration file not found /app_name/config/webpacker.yml. Please run rails webpacker:install 
 Error: No such file or directory @ rb_sysopen - /app_name/config/webpacker.yml (RuntimeError)
```
ãƒ¡ãƒƒãƒƒã‚»ãƒ¼ã‚¸ã®é€šã‚Šã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ

```
 docker-compose run web rails webpacker:install
# ç•¥
Webpacker successfully installed ğŸ‰ ğŸ°
```

å†åº¦å®Ÿè¡Œ

```
docker-compose up web
```

`http://localhost:3000/` ã§ã„ã¤ã‚‚ã®ç”»é¢ã§è¦‹ã‚Œã‚Œã°OK


## rails ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œ

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ã‚‚ã†ï¼‘ã¤ç«‹ã¡ä¸Šã’ã¦railsã®ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãŠã

docker-compose run [ã‚µãƒ¼ãƒ“ã‚¹å] [railsã‚³ãƒãƒ³ãƒ‰] ã®æ›¸å¼ã§å®Ÿè¡Œ

```
docker-compose run web rails g controller home index
```
`http://localhost:3000/home/index` ã§ä½œæˆã—ãŸç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚Œã°OK

## docker åœæ­¢

```
 docker-compose down   
```

## ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã«å…¥ã£ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã„å ´åˆ

`docker container ls ` ã§å®Ÿè¡Œä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠåã‚’ç¢ºèªå¾Œ

```
docker exec -i -t [ã‚³ãƒ³ãƒ†ãƒŠå] bash
```

## éš ã—ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã‚Œãªã„å ´åˆã¯
`.ruby-version`ã¨ã‹ç¢ºèªã§æ¥ã¦ã„ãªã„å ´åˆã¯ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ

```
defaults write com.apple.finder AppleShowAllFiles TRUE
```

Finderã‚’å¼·åˆ¶å†èµ·å‹•